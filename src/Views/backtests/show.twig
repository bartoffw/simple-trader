{% extends "layout.twig" %}

{% set active_menu = 'runs' %}

{% block title %}Run #{{ run.id }} - {{ app_name }}{% endblock %}

{% block page_title %}Backtest Run #{{ run.id }}{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="/tickers">Home</a></li>
    <li class="breadcrumb-item"><a href="/backtests">Backtests</a></li>
    <li class="breadcrumb-item active">Run #{{ run.id }}</li>
{% endblock %}

{% block content %}
    <!-- Status Banner -->
    <div class="row">
        <div class="col-12">
            {% if run.status == 'completed' %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <strong>Backtest Completed!</strong>
                    Execution time: {{ run.execution_time_seconds|number_format(2) }} seconds
                </div>
            {% elseif run.status == 'running' %}
                <div class="alert alert-warning">
                    <i class="fas fa-spinner fa-spin"></i>
                    <strong>Backtest Running...</strong>
                    Logs are updated in real-time below.
                </div>
            {% elseif run.status == 'failed' %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Backtest Failed</strong>
                    {% if run.error_message %}
                        <br>{{ run.error_message }}
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-hourglass-half"></i>
                    <strong>Backtest Pending</strong>
                    The backtest is queued and will start shortly.
                </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Configuration Details -->
        <div class="col-md-4">
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Configuration</h3>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-5">Name</dt>
                        <dd class="col-sm-7">{{ run.name }}</dd>

                        <dt class="col-sm-5">Strategy</dt>
                        <dd class="col-sm-7">
                            {{ run.strategy_info.strategy_name }}<br>
                            <small class="text-muted">{{ run.strategy_class }}</small>
                        </dd>

                        <dt class="col-sm-5">Period</dt>
                        <dd class="col-sm-7">
                            {{ run.start_date }}<br>to {{ run.end_date }}
                        </dd>

                        <dt class="col-sm-5">Initial Capital</dt>
                        <dd class="col-sm-7">${{ run.initial_capital|number_format(2) }}</dd>

                        <dt class="col-sm-5">Tickers</dt>
                        <dd class="col-sm-7">
                            {% for ticker in run.tickers_info %}
                                <span class="badge badge-info">{{ ticker.symbol }}</span>
                            {% endfor %}
                        </dd>

                        {% if run.benchmark_info %}
                            <dt class="col-sm-5">Benchmark</dt>
                            <dd class="col-sm-7">
                                <span class="badge badge-secondary">{{ run.benchmark_info.symbol }}</span>
                            </dd>
                        {% endif %}

                        <dt class="col-sm-5">Optimization</dt>
                        <dd class="col-sm-7">
                            {% if run.is_optimization %}
                                <span class="badge badge-warning">Yes</span>
                            {% else %}
                                <span class="badge badge-secondary">No</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-5">Created</dt>
                        <dd class="col-sm-7">
                            <small>{{ run.created_at }}</small>
                        </dd>
                    </dl>

                    <!-- Strategy Parameters -->
                    {% if run.strategy_parameters_decoded %}
                        <h6 class="mt-3">Strategy Parameters</h6>
                        <table class="table table-sm table-bordered">
                            {% for key, value in run.strategy_parameters_decoded %}
                                <tr>
                                    <td><strong>{{ key }}</strong></td>
                                    <td class="text-right">{{ value }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    {% endif %}

                    <!-- Optimization Parameters -->
                    {% if run.optimization_params_decoded %}
                        <h6 class="mt-3">Optimization Ranges</h6>
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Step</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for param in run.optimization_params_decoded %}
                                    <tr>
                                        <td><strong>{{ param.name }}</strong></td>
                                        <td>{{ param.from }}</td>
                                        <td>{{ param.to }}</td>
                                        <td>{{ param.step }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Results Summary -->
        <div class="col-md-8">
            {% if run.metrics %}
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title">Results Summary</h3>
                        <div class="card-tools">
                            {% if run.report_html %}
                                <a href="/runs/{{ run.id }}/report" class="btn btn-sm btn-success" download>
                                    <i class="fas fa-download"></i> Download Report
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon {{ run.metrics.net_profit >= 0 ? 'bg-success' : 'bg-danger' }}">
                                        <i class="fas fa-dollar-sign"></i>
                                    </span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Net Profit</span>
                                        <span class="info-box-number">
                                            ${{ run.metrics.net_profit|number_format(2) }}
                                            <br><small>{{ run.metrics.net_profit_percent|number_format(2) }}%</small>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-info">
                                        <i class="fas fa-exchange-alt"></i>
                                    </span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Transactions</span>
                                        <span class="info-box-number">
                                            {{ run.metrics.total_transactions }}
                                            <br><small>{{ run.metrics.profitable_transactions }} profitable</small>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-warning">
                                        <i class="fas fa-chart-line"></i>
                                    </span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Profit Factor</span>
                                        <span class="info-box-number">{{ run.metrics.profit_factor|number_format(2) }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-danger">
                                        <i class="fas fa-arrow-down"></i>
                                    </span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Max Drawdown</span>
                                        <span class="info-box-number">
                                            ${{ run.metrics.max_drawdown_value|number_format(2) }}
                                            <br><small>{{ run.metrics.max_drawdown_percent|number_format(2) }}%</small>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Execution Logs -->
            <div class="card card-secondary">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-terminal"></i> Execution Logs
                    </h3>
                    <div class="card-tools">
                        {% if run.status == 'running' or run.status == 'pending' %}
                            <span class="badge badge-warning">
                                <i class="fas fa-sync fa-spin"></i> Live
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="log-output" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap;">
                        {{ run.log_output|default('No logs yet...') }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HTML Report (if available) -->
    {% if run.report_html %}
        <div class="row">
            <div class="col-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-file-alt"></i> Backtest Report
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <iframe id="report-iframe"
                                style="width: 100%; min-height: 800px; border: none;"
                                srcdoc="{{ run.report_html|e('html') }}">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <a href="/runs" class="btn btn-default">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
            {% if run.status != 'running' %}
                <form action="/runs/{{ run.id }}/delete" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this run?');">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Run
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const runId = {{ run.id }};
    const runStatus = '{{ run.status }}';
    let pollInterval = null;
    let lastLogLength = 0;

    // Auto-scroll logs to bottom
    function scrollLogsToBottom() {
        const logOutput = $('#log-output');
        logOutput.scrollTop(logOutput[0].scrollHeight);
    }

    // Poll for log updates if run is pending or running
    function pollLogs() {
        $.ajax({
            url: '/runs/' + runId + '/logs',
            method: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    // Update logs if changed
                    if (response.log_output && response.log_output.length > lastLogLength) {
                        $('#log-output').text(response.log_output);
                        lastLogLength = response.log_output.length;
                        scrollLogsToBottom();
                    }

                    // Check if run completed
                    if (response.status === 'completed' || response.status === 'failed') {
                        // Stop polling
                        if (pollInterval) {
                            clearInterval(pollInterval);
                            pollInterval = null;
                        }

                        // Reload page to show results
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('Error polling logs:', error);
            }
        });
    }

    // Start polling if run is pending or running
    if (runStatus === 'pending' || runStatus === 'running') {
        // Initial poll
        pollLogs();

        // Poll every 2 seconds
        pollInterval = setInterval(pollLogs, 2000);

        // Scroll logs initially
        scrollLogsToBottom();
    } else {
        // For completed runs, just scroll to bottom once
        scrollLogsToBottom();
    }

    // Cleanup on page unload
    $(window).on('beforeunload', function() {
        if (pollInterval) {
            clearInterval(pollInterval);
        }
    });
});
</script>
{% endblock %}
